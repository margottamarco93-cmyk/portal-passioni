<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Passion Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f5f7;
      color: #111827;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 720px;
      background: #ffffff;
      padding: 24px 28px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
      border-radius: 16px;
    }

    h1 {
      margin-top: 0;
      font-size: 1.6rem;
      text-align: center;
    }

    .tagline {
      text-align: center;
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .status {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 8px;
      text-align: right;
    }

    p {
      font-size: 0.95rem;
      line-height: 1.4;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      margin-top: 10px;
    }

    .btn-primary {
      background: #2563eb;
      color: #ffffff;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn + .btn {
      margin-left: 8px;
    }

    label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin: 12px 0 4px;
    }

    input[type="text"],
    input[type="file"],
    textarea,
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      box-sizing: border-box;
    }

    textarea {
      min-height: 90px;
      resize: vertical;
    }

    .hint {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 4px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 4px;
    }

    .tabs button {
      border: none;
      background: transparent;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 0.9rem;
      border-radius: 999px;
    }

    .tabs button.active {
      background: #e5edff;
      color: #1d4ed8;
      font-weight: 600;
    }

    .view {
      margin-top: 8px;
    }

    #selected-passions div {
      font-size: 0.8rem;
    }

    #profiles-list > div {
      transition: box-shadow 0.15s ease;
    }

    #profiles-list > div:hover {
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.04);
    }

    #search-input {
      margin-bottom: 10px;
    }

    .small-text {
      font-size: 0.8rem;
      color: #6b7280;
    }
  </style>

  <!-- Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
  <div class="container">
    <h1>Passion Portal</h1>
    <p class="tagline">Le persone si registrano, creano il loro profilo, condividono passioni.</p>
    <div class="status" id="status-text">Non sei autenticato</div>

    <!-- Vista se NON loggato -->
    <div id="logged-out">
      <p>
        Per iniziare, fai login o registrati. Si aprirà il pannello di Netlify Identity.
      </p>
      <button class="btn btn-primary" id="btn-open-auth">
        Login / Registrati
      </button>
    </div>

    <!-- App interna quando l'utente è loggato -->
    <div id="app" style="display: none;">
      <div class="tabs">
        <button data-tab="profile" class="active">Il mio profilo</button>
        <button data-tab="dashboard">Tutti i profili</button>
      </div>

      <div class="small-text" id="welcome-text"></div>

      <!-- Vista PROFILO -->
      <div id="view-profile" class="view">
        <form id="profile-form">
          <label for="name">Nome</label>
          <input type="text" id="name" placeholder="Es. Marco Rossi" />

          <label for="structure">Struttura di riferimento</label>
          <input type="text" id="structure" placeholder="Es. Vendite, Marketing, HR" />

          <label for="photo">Foto profilo</label>
          <input type="file" id="photo" accept="image/*" />
          <div id="photo-preview" style="margin-top:10px;"></div>

          <label for="passions-select">Passioni</label>
          <select id="passions-select">
            <option value="">— Seleziona una passione —</option>
          </select>
          <button type="button" class="btn btn-secondary" id="btn-add-passion">
            Aggiungi passione
          </button>

          <label>Passioni selezionate</label>
          <div id="selected-passions"></div>

          <label for="new-passion">Aggiungi una passione non presente</label>
          <input type="text" id="new-passion" placeholder="Es. Podcast, Innovazione sociale..." />
          <button type="button" class="btn btn-secondary" id="btn-add-new-passion">
            Aggiungi nuova passione
          </button>

          <label for="description">Descrizione</label>
          <textarea id="description" placeholder="Una breve descrizione di te, del tuo ruolo, dei tuoi interessi..."></textarea>

          <div style="margin-top: 12px;">
            <button type="submit" class="btn btn-primary">Salva profilo</button>
            <button type="button" class="btn btn-secondary" id="btn-logout">Logout</button>
          </div>
        </form>
      </div>

      <!-- Vista DASHBOARD -->
      <div id="view-dashboard" class="view" style="display:none;">
        <label for="search-input">Cerca tra tutti i profili</label>
        <input
          id="search-input"
          type="text"
          placeholder="Cerca per nome, struttura, passioni, descrizione..."
        />
        <div id="profiles-list"></div>
      </div>
    </div>
  </div>

  <script>
    // CONFIG PASSIONI
    const PASSION_LIST = [
      "Viaggi", "Musica", "Tecnologia", "Sport", "Lettura",
      "Fotografia", "Cucina", "Cinema", "Arte", "Gaming",
      "Innovazione", "Startup", "Teatro", "Natura", "Animali",
      "Design", "Scrittura", "Fitness", "Moda", "Volontariato"
    ];

    // ELEMENTI DOM
    const statusText = document.getElementById("status-text");
    const loggedOut = document.getElementById("logged-out");
    const appDiv = document.getElementById("app");
    const welcomeText = document.getElementById("welcome-text");
    const btnOpenAuth = document.getElementById("btn-open-auth");
    const btnLogout = document.getElementById("btn-logout");
    const profileForm = document.getElementById("profile-form");

    const passionsSelect = document.getElementById("passions-select");
    const selectedPassionsDiv = document.getElementById("selected-passions");
    const btnAddPassion = document.getElementById("btn-add-passion");
    const btnAddNewPassion = document.getElementById("btn-add-new-passion");
    const newPassionInput = document.getElementById("new-passion");
    const photoInput = document.getElementById("photo");
    const photoPreview = document.getElementById("photo-preview");
    const searchInput = document.getElementById("search-input");
    const profilesList = document.getElementById("profiles-list");

    const viewProfile = document.getElementById("view-profile");
    const viewDashboard = document.getElementById("view-dashboard");

    let selectedPassions = [];
    let photoBase64 = null;
    let allProfiles = [];

    // Inizializza Netlify Identity
    netlifyIdentity.init();

    // Popola select passioni
    PASSION_LIST.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      passionsSelect.appendChild(opt);
    });

    // UI di base
    function updateUI(user) {
      if (!user) {
        loggedOut.style.display = "block";
        appDiv.style.display = "none";
        statusText.textContent = "Non sei autenticato";
        return;
      }
      loggedOut.style.display = "none";
      appDiv.style.display = "block";
      statusText.textContent = "Autenticato come " + user.email;

      const meta = user.user_metadata || {};
      const displayName = meta.name || user.email;
      welcomeText.textContent = "Ciao " + displayName + ". Qui puoi gestire il tuo profilo e vedere gli altri.";
    }

    function showView(tab) {
      if (tab === "profile") {
        viewProfile.style.display = "block";
        viewDashboard.style.display = "none";
      } else {
        viewProfile.style.display = "none";
        viewDashboard.style.display = "block";
      }
      document.querySelectorAll(".tabs button").forEach(btn => {
        btn.classList.toggle("active", btn.getAttribute("data-tab") === tab);
      });
    }

    function isProfileComplete(user) {
      const m = user.user_metadata || {};
      return m.name && m.name.trim() &&
             Array.isArray(m.passions) &&
             m.passions.length > 0;
    }

    // Gestione passioni selezionate
    function renderSelectedPassions() {
      selectedPassionsDiv.innerHTML = "";

      selectedPassions.forEach((p, idx) => {
        const chip = document.createElement("div");
        chip.style.padding = "6px 10px";
        chip.style.margin = "4px";
        chip.style.display = "inline-block";
        chip.style.background = "#e5e7eb";
        chip.style.borderRadius = "12px";
        chip.textContent = p;

        const remove = document.createElement("span");
        remove.textContent = " ✕";
        remove.style.cursor = "pointer";
        remove.style.marginLeft = "4px";
        remove.onclick = () => {
          selectedPassions.splice(idx, 1);
          renderSelectedPassions();
        };

        chip.appendChild(remove);
        selectedPassionsDiv.appendChild(chip);
      });
    }

    btnAddPassion.onclick = () => {
      const selected = passionsSelect.value;
      if (selected && !selectedPassions.includes(selected)) {
        selectedPassions.push(selected);
        renderSelectedPassions();
      }
    };

    btnAddNewPassion.onclick = () => {
      const np = newPassionInput.value.trim();
      if (np && !selectedPassions.includes(np)) {
        selectedPassions.push(np);
        newPassionInput.value = "";
        renderSelectedPassions();
      }
    };

    // Foto profilo → Base64
    photoInput.addEventListener("change", function () {
      const file = this.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        photoBase64 = e.target.result;
        photoPreview.innerHTML = `<img src="${photoBase64}" width="80" style="border-radius:999px;" />`;
      };
      reader.readAsDataURL(file);
    });

    // Carica dati nel form da user_metadata
    function loadUserProfile(user) {
      const meta = user.user_metadata || {};

      document.getElementById("name").value = meta.name || "";
      document.getElementById("structure").value = meta.structure || "";
      document.getElementById("description").value = meta.description || "";

      selectedPassions = Array.isArray(meta.passions) ? meta.passions.slice() : [];
      renderSelectedPassions();

      if (meta.photo) {
        photoBase64 = meta.photo;
        photoPreview.innerHTML = `<img src="${photoBase64}" width="80" style="border-radius:999px;" />`;
      } else {
        photoBase64 = null;
        photoPreview.innerHTML = "";
      }
    }

    // Login / logout
    btnOpenAuth.addEventListener("click", () => {
      netlifyIdentity.open();
    });

    btnLogout.addEventListener("click", () => {
      netlifyIdentity.logout();
    });

    async function onLogin(user) {
      updateUI(user);
      loadUserProfile(user);

      if (isProfileComplete(user)) {
        showView("dashboard");
        await loadDashboard();
      } else {
        showView("profile");
      }
    }

    netlifyIdentity.on("init", (user) => {
      if (user) {
        onLogin(user);
      } else {
        updateUI(null);
      }
    });

    netlifyIdentity.on("login", (user) => {
      netlifyIdentity.close();
      onLogin(user);
    });

    netlifyIdentity.on("logout", () => {
      updateUI(null);
    });

    // Tab click
    document.querySelectorAll(".tabs button").forEach(btn => {
      btn.addEventListener("click", async () => {
        const tab = btn.getAttribute("data-tab");
        showView(tab);
        if (tab === "dashboard") {
          await loadDashboard();
        }
      });
    });

    // Salvataggio profilo
    profileForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const user = netlifyIdentity.currentUser();
      if (!user) {
        alert("Sessione scaduta. Effettua di nuovo il login.");
        return;
      }

      try {
        await user.update({
          data: {
            name: document.getElementById("name").value.trim(),
            structure: document.getElementById("structure").value.trim(),
            passions: selectedPassions,
            description: document.getElementById("description").value.trim(),
            photo: photoBase64 || null,
          }
        });

        alert("Profilo salvato.");
        // dopo il primo salvataggio puoi mandarlo in dashboard
        if (isProfileComplete(netlifyIdentity.currentUser())) {
          showView("dashboard");
          await loadDashboard();
        }
      } catch (err) {
        console.error(err);
        alert("Errore nel salvataggio del profilo.");
      }
    });

    // DASHBOARD: carica e mostra tutti i profili
    async function loadDashboard() {
      try {
        profilesList.innerHTML = "Caricamento profili...";
        const res = await fetch("/.netlify/functions/get-users");
        if (!res.ok) throw new Error("Errore caricamento profili");
        allProfiles = await res.json();
        renderDashboard("");
      } catch (e) {
        console.error(e);
        profilesList.textContent = "Errore nel caricamento dei profili.";
      }
    }

    function renderDashboard(query) {
      const q = (query || "").toLowerCase();
      profilesList.innerHTML = "";

      allProfiles
        .filter((p) => {
          const text =
            (p.name || "") +
            " " +
            (p.structure || "") +
            " " +
            (p.description || "") +
            " " +
            (Array.isArray(p.passions) ? p.passions.join(" ") : "");
          return text.toLowerCase().includes(q);
        })
        .forEach((p) => {
          const card = document.createElement("div");
          card.style.border = "1px solid #e5e7eb";
          card.style.borderRadius = "8px";
          card.style.padding = "12px";
          card.style.marginTop = "8px";
          card.style.position = "relative";

          if (p.photo) {
            const img = document.createElement("img");
            img.src = p.photo;
            img.width = 48;
            img.height = 48;
            img.style.borderRadius = "999px";
            img.style.position = "absolute";
            img.style.right = "12px";
            img.style.top = "12px";
            card.appendChild(img);
          }

          const title = document.createElement("div");
          title.style.fontWeight = "600";
          title.textContent = p.name || p.email;

          const structure = document.createElement("div");
          structure.style.fontSize = "0.85rem";
          structure.style.color = "#6b7280";
          structure.textContent = p.structure || "";

          const passions = document.createElement("div");
          passions.style.marginTop = "4px";
          passions.style.fontSize = "0.85rem";
          passions.textContent =
            "Passioni: " +
            (Array.isArray(p.passions) && p.passions.length
              ? p.passions.join(", ")
              : "—");

          const descr = document.createElement("div");
          descr.style.marginTop = "4px";
          descr.textContent = p.description || "";

          card.appendChild(title);
          card.appendChild(structure);
          card.appendChild(passions);
          card.appendChild(descr);

          profilesList.appendChild(card);
        });

      if (!profilesList.innerHTML) {
        profilesList.textContent = "Nessun profilo trovato.";
      }
    }

    searchInput.addEventListener("input", (e) => {
      renderDashboard(e.target.value);
    });
  </script>
</body>
</html>
